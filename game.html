<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>block breaker</title>
  <style media="screen">
    canvas {
      border: 1px black solid;
    }
  </style>
  <script src='engine.js'></script>
  <script src='ball.js'></script>
  <script src='paddle.js'></script>
  <script src='block.js'></script>
  <script src='level.js'></script>
  <script src='utils.js'></script>
</head>
<body>
  <canvas id="id-canvas" width="400" height="300"></canvas>
  <hr>
  <input type="range" id="id-input-speed" value="30" min="1">
  <script>
    var loadLevel = function(n) {
      n = n - 1
      var level = levels[n]
      var blocks = []
      for (let i = 0; i < level.length; i++) {
        var p = level[i]
        var b = Block(p)
        blocks.push(b)
      }
      return blocks
    }
    var blocks = []
    var enableDebugMode = function(enable) {
      if (!enable) {
        return
      }
      window.paused = false
      window.addEventListener('keydown', function (e) {
        var k = e.key
        if ('12345567'.includes(k)) {
          blocks = loadLevel(Number(k))
        } else if (k === 'p') {
          paused = !paused
        }
      })
      document.querySelector('#id-input-speed').addEventListener('input', function(event) {
        var input = event.target
        window.fps = Number(input.value) 
      });
    }
    var main = function() { 
      var game = Engine()
 
      var paddle = Paddle()
      var ball = Ball()
      blocks = loadLevel(1)

      game.registerAction('a', function() {
        paddle.moveLeft()
      })
      game.registerAction('d', function() {
        paddle.moveRight()
      })
      game.registerAction('f', function() {
        ball.fire()
      })
      // mouese event
      var enableDrag = false
      window.addEventListener('mousedown', function(event) {
        var x = event.offsetX
        var y = event.offsetY 
        if (ball.hasPoint(x, y)) {
          enableDrag = true
        }
      });
      window.addEventListener('mousemove', function(event) {
        var x = event.offsetX
        var y = event.offsetY 
        if (enableDrag) {
          ball.x = x
          ball.y = y
        }
      });
      window.addEventListener('mouseup', function(event) {
        enableDrag = false
      });

      enableDebugMode(true)

      game.update = function() {
        if (paused) {
          return
        }

        ball.move()
        // 板球相撞则反弹
        if (paddle.collide(ball)) {
          ball.rebound()
        }
        // 每帧循环所有砖块判断是否和球相撞
        for (var i = 0; i < blocks.length; i++) {
          if (blocks[i].collide(ball)) {
            blocks[i].kill()
            ball.rebound()
          }  
        }
      }

      game.draw = function() {
        game.drawImage(paddle)
        game.drawImage(ball)
        for (var i = 0; i < blocks.length; i++) {
          if (blocks[i].alive) {
            game.drawImage(blocks[i])
          }
        }
      }
    }

    main()
  </script>
</body>
</html>