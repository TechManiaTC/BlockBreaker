<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>block breaker</title>
  <style media="screen">
    canvas {
      border: 1px black solid;
    }
  </style>
  <script src='engine.js'></script>
  <script src='ball.js'></script>
  <script src='paddle.js'></script>
  <script src='block.js'></script>
  <script src='level.js'></script>
  <script src='utils.js'></script>
</head>
<body>
  <canvas id="id-canvas" width="400" height="300"></canvas>
  <script>
    var loadLevel = function(n) {
      n = n - 1
      var level = levels[n]
      var blocks = []
      for (let i = 0; i < level.length; i++) {
        var p = level[i]
        var b = Block(p)
        blocks.push(b)
      }
      return blocks
    }
    var main = function() { 
      var game = Engine()
 
      var paddle = Paddle()
      var ball = Ball()

      game.registerAction('a', function() {
        paddle.moveLeft()
      })
      game.registerAction('d', function() {
        paddle.moveRight()
      })
      game.registerAction('f', function() {
        ball.fire()
      })
      var blocks = loadLevel(1)
      window.addEventListener('keydown', function (e) {
        if ('12345567'.includes(e.key)) {
          blocks = loadLevel(Number(e.key))
        }
      });

      game.update = function() {
        if (game.paused) {
          return
        }

        ball.move()
        // 板球相撞则反弹
        if (paddle.collide(ball)) {
          ball.rebound()
        }
        // 每帧循环所有砖块判断是否和球相撞
        for (var i = 0; i < blocks.length; i++) {
          if (blocks[i].collide(ball)) {
            blocks[i].kill()
            ball.rebound()
          }  
        }
      }

      game.draw = function() {
        game.drawImage(paddle)
        game.drawImage(ball)
        for (var i = 0; i < blocks.length; i++) {
          if (blocks[i].alive) {
            game.drawImage(blocks[i])
          }
        }
      }
    }

    main()
  </script>
</body>
</html>